!function(t){function e(){n={};var t=JSON.parse(localStorage.getItem("awareJs-current"));o=JSON.parse(localStorage.getItem("awareJs-archives"))||[],t?(o.push(t),n.firstVisit=!1,n.lastVisitDate=t.date):n.first_visit=!0,n.geolocation=null,n.date=new Date,n.visitDuration=0,n.timeslot=c.getTimeSlot()}function i(t){u=!0,n=t.splice(t.length-1,1)[0],o=t,n.date=new Date(n.date)}var n,o,a,r,s,g,l="PythiaJS",u=!1,d={init:function(){g=navigator.geolocation.watchPosition(function(t){d.handleNewGeoData(t)},function(t){d.handleGeoError(t)})},clearGeolocationWatcher:function(){navigator.geolocation.clearWatch(g)},handleNewGeoData:function(t){if(n.geolocation){var e=n.geolocation.position,i={lat:t.coords.latitude,lon:t.coords.longitude};d.coordinatesAreDifferents(e,i)&&(n.geolocation.hasMoved||(n.geolocation.hasMoved=!0),n.geolocation.hasOwnProperty("position_history")?n.geolocation.position_history.push(n.geolocation.position):n.geolocation.position_history=[n.geolocation.position],n.geolocation.position={lat:t.coords.latitude,lon:t.coords.longitude})}else n.geolocation={position:{lat:t.coords.latitude,lon:t.coords.longitude}}},handleGeoError:function(t){console.warn(t)},coordinatesAreDifferents:function(t,e){return null===t||t.lat===e.lat&&t.lon===e.lon?!1:!0},getApproximatePositionAsString:function(t){return"lat"+t.lat.toFixed(2)+"lon"+t.lon.toFixed(2)},updateRanking:function(t,e){return e[t]?e[t]++:e[t]=1,e}},v={totalHiddenTime:0,init:function(){a=document.documentElement.scrollHeight,r=new Event("pageBottomReached"),window.addEventListener("scroll",v.onScroll),window.addEventListener("pageBottomReached",v.onPageBottomReached),document.addEventListener("visibilitychange",v.onVisibilityChange,!1),window.addEventListener("beforeunload",v.unload,!1),v.onScroll()},onScroll:function(){var t=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop||window.scrollY;t+document.documentElement.clientHeight>=a&&window.dispatchEvent(r)},onPageBottomReached:function(){1!=n.pageBottomReached&&(n.pageBottomReached=!0)},onVisibilityChange:function(){if("hidden"==document.visibilityState)hiddenTimer=(new Date).getTime();else if("visible"==document.visibilityState){var t=(new Date).getTime(),e=t-hiddenTimer;hiddenTimer=null,v.totalHiddenTime+=e}},unload:function(){u||c.updateVisitDuration()}},c={pagesViewsOverlap:function(t,e){return t>e-2500&&e+2500>t?!0:!1},getTimeSlot:function(t){if(t)var e=t;else var e=(new Date).getHours();var i=null;return e>0&&6>e?i="night":e>5&&9>e?i="earlymorning":e>8&&12>e?i="morning":e>11&&15>e?i="midi":e>14&&18>e?i="afternoon":e>17&&24>e&&(i="evening"),i},updateVisitDuration:function(){var t=(new Date).getTime(),e=n.date.getTime(),i=t-e;n.visitDuration=i-v.totalHiddenTime,n.hiddenTime=v.totalHiddenTime,localStorage.setItem("awareJs-current",JSON.stringify(n))},sortVisitsByDay:function(){var t=o.length;sortedDays={};for(var e=0;t>e;e++){var i=c.getDDMMYYYYFromDate(new Date(o[e].date)).full;sortedDays[i]?sortedDays[i].push(o[e]):sortedDays[i]=[o[e]]}return sortedDays},getDDMMYYYYFromDate:function(t){var e=t.getDate().toString(),i=(t.getMonth()+1).toString(),n=t.getFullYear().toString();return{full:e+"-"+i+"-"+n,day:e,month:i,year:n}},getUserVisitRatio:function(t){for(var e=0,i=new Date,n=t-1;n>=0;n--)i.setDate(i.getDate()-1),s[c.getDDMMYYYYFromDate(i).full]&&e++;return e/t},getVisitsSince:function(t){var e=[];if(t){if(!f.isValidDate(t))throw new Error(l+" - getVisitsSince(): Arg must be a Date object or at least convertible to a Date object.");for(var i=new Date(t),n=i.getTime(),a=0;a<o.length;a++){var r=o[a],s=new Date(r.date),g=s.getTime();g>n&&e.push(s)}}else for(var a=0;a<o.length;a++)e.push(o[a].date);return e}},m={OSList:{Win:"Windows",Mac:"OSX",X11:"UNIX",Linux:"Linux"},isMobile:function(){var t=/android|webos|iphone|ipad|ipod|blackberry|windows phone|mobile/i.test(navigator.userAgent)?!0:!1;return t},isTablet:function(){return"@todo: implémenter cette fonction"},isConsole:function(){return"@todo: implémenter cette fonction"},getBrowser:function(){var t={browser:null,version:null},e=navigator.userAgent,i=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return i.length>1&&(t.browser=i[1],t.version=i[2]),t},getOS:function(){var t=navigator.userAgent,e=t.match(/Win|Mac|X11|Linux/i)||[],i=null;if(e.length>0)var i=m.OSList[e];return i}},f={getSessionVisits:function(){for(var t=[],e=o,i=e.length-1;i>=0;i--){var n=new Date(e[i].date).getTime(),a=n+e[i].visitDuration;if(e[i].hiddenTime&&(a+=e[i].hiddenTime),e[i+1]){var r=new Date(e[i+1].date).getTime();if(!c.pagesViewsOverlap(a,r))return t;t.push(e[i])}}return t},isValidDate:function(t){return"[object Date]"!==Object.prototype.toString.call(t)?!1:!isNaN(t.getTime())},getAverageIntervalBetweenVisits:function(){for(var t=[],e=0;e<o.length;e++)if(o[e+1]){var i=new Date(o[e].date),n=new Date(o[e+1].date),a=n.getTime()-i.getTime();t.push(a)}for(var r=0,e=0;e<t.length;e++)r+=t[e];return r/=t.length}},h={version:1,init:function(){e(),d.init(),v.init();try{localStorage.setItem("awareJs-current",JSON.stringify(n)),localStorage.setItem("awareJs-archives",JSON.stringify(o))}catch(t){console.error(t)}},initCustomData:function(t){d.clearGeolocationWatcher(),i(t)},isFirstVisit:function(){return n.firstVisit},getVisits:function(){return o},getLastVisitDate:function(){return new Date(n.lastVisitDate)},getNumberOfVisits:function(){return o.length},getCurrentTimeSlot:function(t){return c.getTimeSlot(t)},getNumberOfVisitsSince:function(t){var e=c.getVisitsSince(t);return e.length},getTimeSinceLastConnection:function(){var t=new Date(n.lastVisitDate).getTime(),e=(new Date).getTime(),i=e-t;return i},getLastVisitDuration:function(){var t=o.length;return o[t-1]?o[t-1].visitDuration:null},getAverageVisitDuration:function(t){for(var e=t?new Date(t).getTime():new Date(o[0].date).getTime(),i=o.length,n=0,a=0,r=0;i>r;r++){var s=new Date(o[r].date).getTime();s>=e&&(a+=1,n+=o[r].visitDuration,console.log(o[r].visitDuration))}return n/a},getAverageVisitDurationPerDay:function(){var t=o.length,e=[];week={0:{totalVisits:0,visitsDurationSum:0,dayString:"dimanche"},1:{totalVisits:0,visitsDurationSum:0,dayString:"lundi"},2:{totalVisits:0,visitsDurationSum:0,dayString:"mardi"},3:{totalVisits:0,visitsDurationSum:0,dayString:"mercredi"},4:{totalVisits:0,visitsDurationSum:0,dayString:"jeudi"},5:{totalVisits:0,visitsDurationSum:0,dayString:"vendredi"},6:{totalVisits:0,visitsDurationSum:0,dayString:"samedi"}};for(var i=0;t>i;i++){var n=new Date(o[i].date).getDay();week[n].totalVisits++,console.log(o[i].visitDuration),week[n].visitsDurationSum+=o[i].visitDuration}console.log(week);for(n in week)if(week.hasOwnProperty(n)){var a=week[n].visitsDurationSum/week[n].totalVisits;isNaN(a)&&(a=0),e.push({day:week[n].dayString,averageDuration:a})}return e.sort(function(t,e){return t.average_duration>e.average_duration?-1:t.average_duration<e.average_duration?1:0}),e},getAverageVisitDurationTimeSlot:function(){var t=o.length,e=[];visitsDurationsPerTimeslot={night:{totalVisits:0,visitsDurationSum:0},earlymorning:{totalVisits:0,visitsDurationSum:0},morning:{totalVisits:0,visitsDurationSum:0},midi:{totalVisits:0,visitsDurationSum:0},afternoon:{totalVisits:0,visitsDurationSum:0},evening:{totalVisits:0,visitsDurationSum:0}};for(var i=0;t>i;i++){var n=c.getTimeSlot(new Date(o[i].date).getUTCHours());visitsDurationsPerTimeslot[n].totalVisits++,visitsDurationsPerTimeslot[n].visitsDurationSum+=o[i].visitDuration}for(timeslot in visitsDurationsPerTimeslot){var a=visitsDurationsPerTimeslot[timeslot].visitsDurationSum/visitsDurationsPerTimeslot[timeslot].totalVisits;isNaN(a)&&(a=0),e.push({timeslot:timeslot,average_duration:a})}return e.sort(function(t,e){return t.average_duration>e.average_duration?-1:t.average_duration<e.average_duration?1:0}),e},getPosition:function(){return n.geolocation?n.geolocation.position:null},getFavoriteTimeslot:function(){var t=o.length,e=[];visitsPerTimeslot={night:{visits:0},earlymorning:{visits:0},morning:{visits:0},midi:{visits:0},afternoon:{visits:0},evening:{visits:0}};for(var i=0;t>i;i++){var n=c.getTimeSlot(new Date(o[i].date).getUTCHours());visitsPerTimeslot[n].visits++}for(timeslot in visitsPerTimeslot)e.push({timeslot:timeslot,visits:visitsPerTimeslot[timeslot].visits});return e.sort(function(t,e){return t.visits>e.visits?-1:t.visits<e.visits?1:0}),e},getVisitsPerTimeslot:function(t){for(var e={earlymorning:0,morning:0,midi:0,afternoon:0,evening:0,night:0},i=0;i<o.length;i++){var n=new Date(o[i].date).getDay();t?t==n&&e[o[i].timeslot]++:e[o[i].timeslot]++}return e},sortDaysByVisits:function(){for(var t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],t=[{day:"sunday",index:0,visits:0},{day:"monday",index:1,visits:0},{day:"tuesday",index:2,visits:0},{day:"wednesday",index:3,visits:0},{day:"thursday",index:4,visits:0},{day:"friday",index:5,visits:0},{day:"saturday",index:6,visits:0}],e=0;e<o.length;e++){var i=new Date(o[e].date).getDay();t[i].visits++}return t.sort(function(t,e){return t.visits>e.visits?-1:t.visits<e.visits?1:0}),console.log(t),t},isDailyUser:function(t){t||(t=7),s=c.sortVisitsByDay();var e=c.getUserVisitRatio(t),i=e>.9?!0:!1;return i},getSessionPageviews:function(){var t=f.getSessionVisits();return t.length},getSessionTimeSpentPerPage:function(){for(var t=f.getSessionVisits(),e=[],i=0;i<t.length;i++)e.push(t[i].visitDuration);return e},getFavoritePlaces:function(){for(var t={},e=0;e<o.length;e++){var i=o[e];if(i.geolocation){var n=d.getApproximatePositionAsString(i.geolocation.position);if(t=d.updateRanking(n,t),i.geolocation.hasMoved)for(var a=0;a<i.geolocation.position_history.length;a++){var n=d.getApproximatePositionAsString(i.geolocation.position_history[a]);t=d.updateRanking(n,t)}}}var r=[],s=[];for(var g in t)t.hasOwnProperty(g)&&r.push([g,t[g]]);r.sort(function(t,e){return t[1]-e[1]});for(var e=0;e<r.length;e++){var g=r[e][0],l=g.indexOf("lat")+3,u=g.indexOf("lon"),v=parseFloat(g.substring(l,u)),c=parseFloat(g.substring(u+3));s.unshift({lat:v,lon:c,visits:r[e][1]})}return s},getAverageIntervalBetweenVisits:function(){for(var t=0,e=0,i=o.length-1;i>=0;i--)if(o[i].lastVisitDate){var n=new Date(o[i].date),a=new Date(o[i].lastVisitDate),r=n.getTime()-a.getTime();t++,e+=r}return total=e/t,total},getPageViewedPageReadRatio:function(){for(var t=f.getSessionVisits(),e=0,i=t.length-1;i>=0;i--)t[i].pageBottomReached&&e++;return t.length/e},getSessionViewedPagesNumber:function(){for(var t=f.getSessionVisits(),e=0,i=t.length-1;i>=0;i--)t[i].pageBottomReached&&e++;return e},isMobile:function(){return m.isMobile()},sortDaysByUserAttention:function(){var t=c.sortVisitsByDay(),e=(new Date,{1:{day:"lundi",pageViews:0,pageRead:0,ratio:0,index:1},2:{day:"mardi",pageViews:0,pageRead:0,ratio:0,index:2},3:{day:"mercredi",pageViews:0,pageRead:0,ratio:0,index:3},4:{day:"jeudi",pageViews:0,pageRead:0,ratio:0,index:4},5:{day:"vendredi",pageViews:0,pageRead:0,ratio:0,index:5},6:{day:"samedi",pageViews:0,pageRead:0,ratio:0,index:6},0:{day:"dimanche",pageViews:0,pageRead:0,ratio:0,index:0}});for(var i in t)if(t.hasOwnProperty(i)){var n=t[i],o=new Date(n[0].date).getDay();e[o].pageViews+=n.length;for(var a=n.length-1;a>=0;a--)n[a].pageBottomReached&&e[o].pageRead++;e[o].ratio=e[o].pageRead/e[o].pageViews}var r=[];for(day in e)r.push(e[day]);return r.sort(function(t,e){return t.ratio>e.ratio?-1:t.ratio<e.ratio?1:0}),r},sortUserAttentionRatioPerTimeslot:function(){for(var t={night:[],earlymorning:[],morning:[],midi:[],afternoon:[],evening:[]},e=0;e<o.length;e++)t[o[e].timeslot].push(o[e].pageBottomReached);var i={earlymorning:{timeslot:"earlymorning",pageViews:0,pageRead:0,ratio:0,timeslot_index:0},morning:{timeslot:"morning",pageViews:0,pageRead:0,ratio:0,timeslot_index:1},midi:{timeslot:"midi",pageViews:0,pageRead:0,ratio:0,timeslot_index:2},afternoon:{timeslot:"afternoon",pageViews:0,pageRead:0,ratio:0,timeslot_index:3},evening:{timeslot:"evening",pageViews:0,pageRead:0,ratio:0,timeslot_index:4},night:{timeslot:"night",pageViews:0,pageRead:0,ratio:0,timeslot_index:5}};for(var n in t)if(t.hasOwnProperty(n)){i[n].pageViews=t[n].length;for(var e=0;e<t[n].length;e++)t[n][e]&&i[n].pageRead++;i[n].ratio=0==i[n].pageViews?0:i[n].pageRead/i[n].pageViews}sortedTimeSlots=[];for(var n in t)sortedTimeSlots.push(i[n]);return sortedTimeSlots.sort(function(t,e){return t.ratio>e.ratio?-1:t.ratio<e.ratio?1:0}),sortedTimeSlots},getBrowser:function(){return m.getBrowser()},getOS:function(){return m.getOS()}};t.pythia=h}(window);